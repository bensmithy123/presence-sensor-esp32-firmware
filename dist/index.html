<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Presence Sensor ESP32 Firmware Flasher</title>
    <style>
      :root {
        color-scheme: light dark;
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
      }
      body {
        margin: 0;
        background: #0b1020;
        color: #f5f7ff;
      }
      main {
        max-width: 900px;
        margin: 0 auto;
        padding: 64px 24px 80px;
      }
      .card {
        background: #121a35;
        border: 1px solid #223060;
        border-radius: 20px;
        padding: 32px;
        box-shadow: 0 20px 60px rgba(4, 10, 25, 0.35);
      }
      h1 {
        font-size: clamp(2rem, 3vw, 2.75rem);
        margin: 0 0 12px;
      }
      p {
        margin: 0 0 16px;
        line-height: 1.6;
        color: #c9d1ff;
      }
      ol {
        margin: 0 0 24px 20px;
        padding: 0;
        color: #c9d1ff;
      }
      li {
        margin-bottom: 10px;
      }
      .note {
        background: rgba(79, 109, 255, 0.15);
        border: 1px solid rgba(79, 109, 255, 0.4);
        border-radius: 12px;
        padding: 12px 16px;
        margin-bottom: 24px;
        color: #d8e1ff;
      }
      .actions {
        display: flex;
        flex-direction: column;
        gap: 20px;
        align-items: flex-start;
      }
      .board-section {
        margin: 8px 0 24px;
        padding: 16px;
        border-radius: 14px;
        border: 1px solid rgba(141, 212, 255, 0.35);
        background: rgba(8, 14, 32, 0.35);
      }
      .board-section h2 {
        margin: 0 0 10px;
        font-size: 1.1rem;
      }
      .board-section ul {
        margin: 0;
        padding-left: 20px;
        color: #c9d1ff;
      }
      .board-section li {
        margin-bottom: 8px;
      }
      .action-card {
        width: 100%;
        padding: 16px;
        border: 1px solid rgba(141, 212, 255, 0.35);
        border-radius: 16px;
        background: rgba(8, 14, 32, 0.35);
      }
      .action-card h2 {
        margin: 0 0 8px;
        font-size: 1.2rem;
      }
      .action-card h3 {
        margin: 0 0 8px;
        font-size: 1rem;
      }
      .action-card p {
        margin-bottom: 12px;
      }
      esp-web-install-button {
        --esp-tools-button-color: #0b1020;
        --esp-tools-button-text-color: #c9d1ff;
        --esp-tools-button-border-radius: 12px;
        --esp-tools-button-background: #8dd4ff;
        --esp-tools-button-hover-background: #70c6ff;
        --esp-tools-button-shadow: 0 10px 25px rgba(110, 198, 255, 0.35);
      }
      .footer {
        margin-top: 32px;
        font-size: 0.9rem;
        color: #97a3d8;
      }
      a {
        color: inherit;
      }
      @media (prefers-color-scheme: light) {
        body {
          background: #eef2ff;
          color: #101625;
        }
        .card {
          background: #ffffff;
          border-color: #d8def5;
        }
        p,
        ol,
        .note,
        .footer {
          color: #39446d;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <div class="card">
        <h1>Presence Sensor Firmware Flasher</h1>
        <p>
          Flash the latest firmware directly from your browser. This uses the
          Web Serial API, so it works in Chromium-based browsers (Chrome, Edge,
          Brave) on desktop.
        </p>
        <div class="note">
          You will be asked to select the ESP32 serial port during the flash
          process.
        </div>
        <ol>
          <li>Connect the Presence Sensor board via USB.</li>
          <li>Choose your board and install mode below.</li>
          <li>Wait for the flash to complete before disconnecting.</li>
        </ol>

        <section class="board-section">
          <h2>Board flash targets</h2>
          <ul>
            <li><strong>ESP32 DevKit:</strong> Standard ESP32 build.</li>
            <li><strong>ESP32-S3 DevKit:</strong> S3 build with PIR input support.</li>
            <li><strong>ESP32-C3 DevKitM-1:</strong> New C3 build with LD2410 UART on GPIO7/6, I2C on GPIO4/5, and reserved LD2450 UART pins on GPIO19/18.</li>
          </ul>
        </section>

        <div class="actions" id="firmware-actions"></div>

        <p class="footer">
          Having trouble? Make sure no other apps are using the serial port and
          try a different USB cable if the device does not appear.
        </p>
      </div>
    </main>

    <template id="firmware-template">
      <div class="action-card">
        <h2 class="firmware-name"></h2>

        <h3>Wipe &amp; Install (factory)</h3>
        <p>
          Best for a fresh install or when you want to reset everything. This
          will erase the device during setup and flash the full factory image.
        </p>
        <esp-web-install-button class="wipe-button"></esp-web-install-button>

        <h3>Update (keep Wi-Fi)</h3>
        <p>
          Updates only the application firmware, keeping NVS intact so Wi-Fi
          credentials and provisioning remain in place. No erase prompt is
          required.
        </p>
        <esp-web-install-button class="keep-button"></esp-web-install-button>
      </div>
    </template>

    <script
      type="module"
      src="https://unpkg.com/esp-web-tools@10/dist/web/install-button.js?module"
    ></script>
    <script>
      const titleFromName = (name) => name.replace(/-/g, " ").toUpperCase();

      async function renderFirmwares() {
        const response = await fetch("./manifest-index.json", { cache: "no-store" });
        if (!response.ok) {
          throw new Error(`Unable to load manifest index (${response.status})`);
        }

        const payload = await response.json();
        const entries = payload.firmwares || [];
        const actions = document.getElementById("firmware-actions");
        const template = document.getElementById("firmware-template");

        for (const entry of entries) {
          const fragment = template.content.cloneNode(true);
          fragment.querySelector(".firmware-name").textContent = titleFromName(entry.name);
          fragment
            .querySelector(".wipe-button")
            .setAttribute("manifest", `./${entry.wipe_manifest}`);
          fragment
            .querySelector(".keep-button")
            .setAttribute("manifest", `./${entry.keep_manifest}`);
          actions.appendChild(fragment);
        }
      }

      renderFirmwares().catch((error) => {
        const actions = document.getElementById("firmware-actions");
        actions.innerHTML = `<p>Unable to load firmware list: ${error.message}</p>`;
      });
    </script>
  </body>
</html>
